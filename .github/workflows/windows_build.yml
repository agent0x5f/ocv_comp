name: Generar EXE con Fecha y Hora (Sin Año)
on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Descargar codigo fuente
        uses: actions/checkout@v4

      # 1. Configurar Cache de OpenCV
      - name: Cache OpenCV
        id: cache-opencv
        uses: actions/cache@v4
        with:
          path: C:\tools\opencv
          key: ${{ runner.os }}-opencv-4.13.0

      - name: Instalar OpenCV (Solo si no hay cache)
        if: steps.cache-opencv.outputs.cache-hit != 'true'
        run: choco install opencv -y

      # 2. Generar Timestamp (MesDia_HoraMinuto)
      - name: Generar Timestamp
        id: times
        shell: powershell
        run: |
          # Formato: MesDia_HoraMinuto (Ej: 0211_1830)
          $timestamp = Get-Date -Format "MMdd_HHmm"
          echo "timestamp=$timestamp" >> $env:GITHUB_OUTPUT

      # 3. Compilar con el nuevo nombre
      - name: Compilar con Timestamp
        shell: powershell
        env:
          TS: ${{ steps.times.outputs.timestamp }}
        run: |
          $libDir = "C:\tools\opencv\build\x64\vc16\lib"
          $incDir = "C:\tools\opencv\build\include"
          $binDir = "C:\tools\opencv\build\x64\vc16\bin"
          
          # Nombre del archivo sin el año
          $exeName = "detector_$env:TS.exe"
          Write-Host "Generando archivo: $exeName"

          $msvcCmd = "cl.exe main.cpp /I`"$incDir`" /EHsc /MD /link /LIBPATH:`"$libDir`" opencv_world4130.lib user32.lib gdi32.lib advapi32.lib shell32.lib /OUT:$exeName"
          
          cmd.exe /c "call `"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat`" && $msvcCmd"

          # Copiar la DLL necesaria
          copy "$binDir\opencv_world4130.dll" .

      - name: Subir Artefacto
        uses: actions/upload-artifact@v4
        with:
          name: detector-build-${{ steps.times.outputs.timestamp }}
          path: |
            *.exe
            *.dll
