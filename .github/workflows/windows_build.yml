name: Generar EXE para Windows
on: [push] # Se activa cada vez que subes cambios

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Descargar código
        uses: actions/checkout@v4

      - name: Configurar OpenCV en Windows
        run: |
          # Usamos Chocolatey para instalar OpenCV rápidamente
          choco install opencv -y
          echo "OPENCV_DIR=C:\tools\opencv\build" >> $GITHUB_ENV

      - name: Compilar Todo-en-Uno (Standalone EXE)
        shell: cmd
        run: |
          :: 1. Entorno de Visual Studio
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

          :: 2. Rutas a las librerías ESTÁTICAS
          set "OPENCV_INC=C:\tools\opencv\build\include"
          set "OPENCV_STATIC_LIB=C:\tools\opencv\build\x64\vc16\staticlib"

          :: 3. Compilar
          :: /MT: Runtime de C++ estático
          :: Enlazamos todas las dependencias necesarias de Windows para OpenCV estático
          cl.exe main.cpp /I"%OPENCV_INC%" /EHsc /MT ^
          /link /LIBPATH:"%OPENCV_STATIC_LIB%" ^
          opencv_world4130s.lib ^
          ade.lib Irpp.lib quirc.lib zlib.lib libjpeg-turbo.lib libpng.lib libtiff.lib libjasper.lib libwebp.lib ^
          user32.lib gdi32.lib comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib kernel32.lib ^
          /OUT:detector_bordes_total.exe

          :: 4. Verificación
          if exist detector_bordes_total.exe (
              echo "¡Éxito! Ejecutable único generado."
          ) else (
              echo "Error en la compilación estática."
              exit /b 1
          )

      - name: Subir un solo archivo
        uses: actions/upload-artifact@v4
        with:
          name: detector-bordes-standalone
          path: detector_bordes_total.exe

      - name: Subir Artefacto Final
        uses: actions/upload-artifact@v4
        with:
          name: detector-bordes-portable
          path: |
            detector_bordes.exe
            opencv_world4130.dll 
          
      - name: Subir Resultado (EXE + DLL)
        uses: actions/upload-artifact@v4
        with:
          name: programa-opencv-windows
          path: |
            detector_bordes.exe
            *.dll
