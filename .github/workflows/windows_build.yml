name: Generar EXE para Windows
on: [push] # Se activa cada vez que subes cambios

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Descargar código
        uses: actions/checkout@v4

      - name: Configurar OpenCV en Windows
        run: |
          # Usamos Chocolatey para instalar OpenCV rápidamente
          choco install opencv -y
          echo "OPENCV_DIR=C:\tools\opencv\build" >> $GITHUB_ENV

      - name: Compilar y Empaquetar
        shell: powershell
        run: |
          # 1. Identificar la librería y versión
          $libPath = "C:\tools\opencv\build\x64\vc16\lib"
          $binPath = "C:\tools\opencv\build\x64\vc16\bin"
          $includePath = "C:\tools\opencv\build\include"
          
          $libFile = Get-ChildItem -Path $libPath -Filter "opencv_world*.lib" | Select-Object -First 1
          $libName = $libFile.Name.Replace(".lib", "")
          $dllName = $libFile.Name.Replace(".lib", ".dll")

          echo "Usando: $libName"

          # 2. Compilar con rutas de inclusión dobles por seguridad
          g++ main.cpp -o detector_bordes.exe `
          -I"$includePath" `
          -I"$includePath\opencv2" `
          -L"$libPath" `
          -l$libName

          # 3. Copiar la DLL al lado del EXE para que pueda ejecutarse
          copy "$binPath\$dllName" .
          
      - name: Subir Resultado (EXE + DLL)
        uses: actions/upload-artifact@v4
        with:
          name: programa-opencv-windows
          path: |
            detector_bordes.exe
            *.dll
