name: Generar EXE para Windows
on: [push] # Se activa cada vez que subes cambios

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Descargar código
        uses: actions/checkout@v4

      - name: Configurar OpenCV en Windows
        run: |
          # Usamos Chocolatey para instalar OpenCV rápidamente
          choco install opencv -y
          echo "OPENCV_DIR=C:\tools\opencv\build" >> $GITHUB_ENV

      - name: Compilar con MSVC
        shell: cmd
        run: |
          :: 1. Configurar entorno de Visual Studio
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

          :: 2. Definir variables de ruta
          set "OPENCV_INC=C:\tools\opencv\build\include"
          set "OPENCV_LIB=C:\tools\opencv\build\x64\vc16\lib"
          set "OPENCV_BIN=C:\tools\opencv\build\x64\vc16\bin"

          :: 3. Compilar
          :: /EHsc: Manejo de excepciones de C++
          :: /I: Ruta de headers
          :: /link: Pasar opciones al enlazador
          cl.exe main.cpp /I"%OPENCV_INC%" /EHsc /link /LIBPATH:"%OPENCV_LIB%" opencv_world4130.lib /OUT:detector_bordes.exe

          :: 4. Verificar y copiar DLL
          if exist detector_bordes.exe (
              copy "%OPENCV_BIN%\opencv_world4130.dll" .
              echo Compilacion exitosa.
          ) else (
              echo Error: No se pudo crear el ejecutable.
              exit /b 1
          )    
          
      - name: Subir Resultado (EXE + DLL)
        uses: actions/upload-artifact@v4
        with:
          name: programa-opencv-windows
          path: |
            detector_bordes.exe
            *.dll
