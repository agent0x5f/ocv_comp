name: Generar EXE para Windows
on: [push] # Se activa cada vez que subes cambios

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Descargar código
        uses: actions/checkout@v4

      - name: Configurar OpenCV en Windows
        run: |
          # Usamos Chocolatey para instalar OpenCV rápidamente
          choco install opencv -y
          echo "OPENCV_DIR=C:\tools\opencv\build" >> $GITHUB_ENV

      - name: Compilar y Empaquetar
        shell: powershell
        run: |
          # 1. Rutas
          $libPath = "C:\tools\opencv\build\x64\vc16\lib"
          $binPath = "C:\tools\opencv\build\x64\vc16\bin"
          $includePath = "C:\tools\opencv\build\include"
          
          # 2. Identificar la librería real
          $libFile = Get-ChildItem -Path $libPath -Filter "opencv_world*.lib" | Select-Object -First 1
          $name = $libFile.BaseName
          $dllName = $libFile.Name.Replace(".lib", ".dll")
          
          Write-Host "Libreria detectada: $name"

          # 3. COMPILAR (Usando interpolación de strings de PowerShell corregida)
          # Al encerrar el comando en una variable y usar Invoke-Expression, 
          # obligamos a PS a reemplazar $name por opencv_world4130 antes de llamar a g++
          $compileCmd = "g++ main.cpp -o detector_bordes.exe -I`"$includePath`" -L`"$libPath`" -l$name"
          Invoke-Expression $compileCmd

          # 4. Copiar archivos necesarios
          if (Test-Path "detector_bordes.exe") {
              copy "$binPath\$dllName" .
              Write-Host "Compilacion exitosa."
          } else {
              Write-Error "No se genero el ejecutable."
              exit 1
          }
          
      - name: Subir Resultado (EXE + DLL)
        uses: actions/upload-artifact@v4
        with:
          name: programa-opencv-windows
          path: |
            detector_bordes.exe
            *.dll
