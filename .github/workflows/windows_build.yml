name: compila_final
on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Descargar codigo fuente
        uses: actions/checkout@v4

      - name: Cache Dependencias
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            C:\tools\opencv
            C:\tools\wxwidgets
          key: ${{ runner.os }}-final-v1

      - name: Instalar OpenCV
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: choco install opencv -y

      - name: Descargar wxWidgets (Dev/DLL)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          # Usamos la version _Dev que sabemos que SI descarga correctamente
          $url_headers = "https://github.com/wxWidgets/wxWidgets/releases/download/v3.2.4/wxWidgets-3.2.4-headers.7z"
          $url_dev_libs = "https://github.com/wxWidgets/wxWidgets/releases/download/v3.2.4/wxMSW-3.2.4_vc14x_x64_Dev.7z"
          
          New-Item -ItemType Directory -Force -Path C:\tools\wxwidgets
          
          echo "Descargando headers..."
          curl.exe -fL $url_headers -o wx_headers.7z --retry 3
          
          echo "Descargando binarios Dev..."
          curl.exe -fL $url_dev_libs -o wx_binaries.7z --retry 3
          
          echo "Extrayendo..."
          7z x wx_headers.7z -oC:\tools\wxwidgets -y
          7z x wx_binaries.7z -oC:\tools\wxwidgets -y

      - name: Generar Timestamp
        id: times
        shell: powershell
        run: |
          $timestamp = Get-Date -Format "MMdd_HHmm"
          echo "timestamp=$timestamp" >> $env:GITHUB_OUTPUT

      - name: Compilar y Empaquetar
        shell: powershell
        env:
          TS: ${{ steps.times.outputs.timestamp }}
        run: |
          # --- 1. CONFIGURACIÓN DE RUTAS ---
          $cvBase = "C:\tools\opencv\build"
          $cvLib = "$cvBase\x64\vc16\lib"
          $cvInc = "$cvBase\include"
          $cvBin = "$cvBase\x64\vc16\bin"
          
          $wxBase = "C:\tools\wxwidgets"
          
          # BUSQUEDA INTELIGENTE DE setup.h
          # Buscamos el archivo setup.h dentro de una carpeta 'mswu' (Unicode Release)
          $setupFile = Get-ChildItem -Path $wxBase -Recurse -Filter "setup.h" | Where-Object { $_.FullName -like "*mswu\wx\setup.h" } | Select-Object -First 1
          
          if (!$setupFile) {
              echo "ERROR CRITICO: No se encontro wx/setup.h. Listando estructura:"
              Get-ChildItem -Path $wxBase -Depth 3
              exit 1
          }
          
          # La carpeta de inclusión es la que contiene 'wx/setup.h', es decir, la carpeta padre de 'wx'
          $wxSetupInc = $setupFile.Directory.Parent.FullName
          # La carpeta de librerías (.lib) suele ser la carpeta padre de 'mswu'
          $wxLibPath = $setupFile.Directory.Parent.Parent.FullName
          
          echo "Ruta Setup detectada: $wxSetupInc"
          echo "Ruta Libs detectada: $wxLibPath"

          $exeName = "detector_$env:TS.exe"

          # --- 2. COMPILACIÓN ---
          # Flags clave:
          # /MD -> Usar runtime dinámico (compatible con las DLLs que bajamos)
          # WXUSINGDLL -> Obligatorio porque bajamos el paquete _Dev
          $wxLibs = "wxmsw32u_core.lib wxbase32u.lib wxtiff.lib wxjpeg.lib wxpng.lib wxzlib.lib comctl32.lib rpcrt4.lib"
          $cvLibs = "opencv_world4130.lib"
          $sysLibs = "user32.lib gdi32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib"

          $msvcCmd = "cl.exe main.cpp /I`"$cvInc`" /I`"$wxBase\include`" /I`"$wxSetupInc`" /D`"__WXMSW__`" /D`"WXUSINGDLL`" /D`"UNICODE`" /D`"_UNICODE`" /EHsc /MD /D`"NDEBUG`" /link /LIBPATH:`"$cvLib`" /LIBPATH:`"$wxLibPath`" $cvLibs $wxLibs $sysLibs /OUT:$exeName"
          
          cmd.exe /c "call `"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat`" && $msvcCmd"

          # --- 3. EMPAQUETADO QUIRÚRGICO (Evita crashes) ---
          echo "Copiando dependencias exactas..."
          
          # Copiamos OpenCV
          copy "$cvBin\opencv_world4130.dll" .
          
          # Copiamos SOLO las DLLs de wxWidgets Release (32u)
          # Buscamos wxbase32u...dll y wxmsw32u_core...dll donde sea que estén
          $wxDlls = Get-ChildItem -Path $wxBase -Recurse -Include "wxbase32u_*.dll", "wxmsw32u_core_*.dll"
          foreach ($dll in $wxDlls) {
              echo "Copiando wxDLL: $($dll.Name)"
              copy $dll.FullName .
          }

          # Copiamos Runtime C++ (Evita error de msvcp140.dll)
          $sysDlls = @("msvcp140.dll", "vcruntime140.dll", "vcruntime140_1.dll")
          foreach ($dll in $sysDlls) {
              $found = Get-ChildItem -Path "C:\Program Files\Microsoft Visual Studio\2022\Enterprise" -Recurse -Filter $dll | Select-Object -First 1
              if ($found) { copy $found.FullName . }
          }
          
          echo "Archivos finales:"
          ls *.exe, *.dll

      - name: Subir Artefacto
        uses: actions/upload-artifact@v4
        with:
          name: detector-final-${{ steps.times.outputs.timestamp }}
          path: |
            *.exe
            *.dll
