name: Generar EXE para Windows
on: [push] # Se activa cada vez que subes cambios

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Descargar código
        uses: actions/checkout@v4

      - name: Configurar OpenCV en Windows
        run: |
          # Usamos Chocolatey para instalar OpenCV rápidamente
          choco install opencv -y
          echo "OPENCV_DIR=C:\tools\opencv\build" >> $GITHUB_ENV

      - name: Compilar y Empaquetar
        shell: powershell
        run: |
          # 1. Definir rutas
          $libPath = "C:\tools\opencv\build\x64\vc16\lib"
          $binPath = "C:\tools\opencv\build\x64\vc16\bin"
          $includePath = "C:\tools\opencv\build\include"
          
          # 2. Encontrar la librería (opencv_world4130)
          $libFile = Get-ChildItem -Path $libPath -Filter "opencv_world*.lib" | Select-Object -First 1
          $libNameOnly = $libFile.BaseName # Esto quita el .lib
          $dllName = $libFile.Name.Replace(".lib", ".dll")

          Write-Host "Compilando con: $libNameOnly"

          # 3. COMPILAR (Usando el nombre real de la librería directamente)
          # Usamos & para ejecutar y pasamos las variables de PowerShell de forma segura
          & g++ main.cpp -o detector_bordes.exe `
          -I"$includePath" `
          -L"$libPath" `
          -l$libNameOnly

          # 4. Copiar la DLL para el artefacto
          copy "$binPath\$dllName" .
          
      - name: Subir Resultado (EXE + DLL)
        uses: actions/upload-artifact@v4
        with:
          name: programa-opencv-windows
          path: |
            detector_bordes.exe
            *.dll
