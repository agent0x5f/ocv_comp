name: Generar Standalone EXE (OpenCV Estático)
on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Descargar codigo fuente
        uses: actions/checkout@v4

      - name: Instalar OpenCV via Chocolatey
        run: |
          choco install opencv -y
          # Nota: Chocolatey instala en C:\tools\opencv por defecto

      - name: Compilar Ejecutable Unico (Standalone)
        shell: powershell
        run: |
          # 1. Definir rutas de la instalacion
          $staticLibPath = "C:\tools\opencv\build\x64\vc16\staticlib"
          $incPath = "C:\tools\opencv\build\include"
          
          # 2. Autodetectar todas las librerias .lib en la carpeta estatica
          # Esto evita fallos si el archivo no se llama 'opencv_world'
          $libs = Get-ChildItem -Path $staticLibPath -Filter "*.lib" | ForEach-Object { $_.Name }
          $allLibs = $libs -join " "
          
          Write-Host "Librerias encontradas para enlazar: $allLibs"

          # 3. Comando de compilacion para MSVC (cl.exe)
          # /MT: Enlace estatico del runtime de C++
          # /EHsc: Habilitar excepciones de C++
          # Se agregan librerias de sistema de Windows necesarias para video y ventanas
          $msvcCmd = "cl.exe main.cpp /I`"$incPath`" /EHsc /MT /link /LIBPATH:`"$staticLibPath`" $allLibs user32.lib gdi32.lib comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib kernel32.lib vfw32.lib cap-msmf.lib msimg32.lib /OUT:detector_bordes_final.exe"
          
          # 4. Ejecutar dentro del entorno de Visual Studio 2022
          cmd.exe /c "call `"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat`" && $msvcCmd"

          # 5. Validacion de salida
          if (Test-Path "detector_bordes_final.exe") {
              Write-Host "¡Exito! El archivo standalone ha sido creado."
          } else {
              Write-Error "Error: No se encontro el archivo generado."
              exit 1
          }

      - name: Subir Artefacto (Solo el EXE)
        uses: actions/upload-artifact@v4
        with:
          name: programa-opencv-estatico
          path: detector_bordes_final.exe
