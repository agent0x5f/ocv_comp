name: Generar Standalone EXE (Auto-Rutas)
on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Descargar codigo fuente
        uses: actions/checkout@v4

      - name: Instalar OpenCV
        run: |
          choco install opencv -y

      - name: Localizar OpenCV y Compilar
        shell: powershell
        run: |
          # 1. Localizar rutas
          $basePath = "C:\tools\opencv\build"
          $staticLibPath = Get-ChildItem -Path $basePath -Filter "staticlib" -Recurse | Select-Object -First 1
          
          if ($null -eq $staticLibPath) {
              Write-Host "Usando modo DINAMICO (DLLs)..."
              $libDir = "C:\tools\opencv\build\x64\vc16\lib"
              $runtimeFlag = "/MD"
              # Enlazamos solo la libreria principal (evitamos el error de cap-msmf.lib)
              $libsToLink = "opencv_world4130.lib"
          } else {
              Write-Host "Usando modo ESTATICO..."
              $libDir = $staticLibPath.FullName
              $runtimeFlag = "/MT"
              $libsToLink = (Get-ChildItem -Path $libDir -Filter "*.lib" | ForEach-Object { $_.Name }) -join " "
          }

          $incDir = "C:\tools\opencv\build\include"
          
          # 2. Comando de compilacion limpio
          # Eliminamos cap-msmf.lib y otros que causan conflictos en modo dinamico
          $msvcCmd = "cl.exe main.cpp /I`"$incDir`" /EHsc $runtimeFlag /link /LIBPATH:`"$libDir`" $libsToLink user32.lib gdi32.lib advapi32.lib shell32.lib /OUT:detector_final.exe"
          
          # 3. Ejecutar compilacion
          cmd.exe /c "call `"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat`" && $msvcCmd"

          # 4. Copiar DLLs necesarias si estamos en modo dinamico
          if ($runtimeFlag -eq "/MD") {
              $binDir = "C:\tools\opencv\build\x64\vc16\bin"
              copy "$binDir\opencv_world4130.dll" .
          }

      - name: Subir Resultado
        uses: actions/upload-artifact@v4
        with:
          name: programa-opencv-final
          path: |
            detector_final.exe
            *.dll
